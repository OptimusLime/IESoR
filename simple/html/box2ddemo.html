<html>
    <head>
      <title>IESoR Starter Kit</title>
      <script>
        var Module = { TOTAL_MEMORY: 256*1024*1024 };
      </script>
      <script src="../js/libs/d3.v3.min.js" type="text/javascript"></script>
      <script src="../js/libs/fabric.min.js" type="text/javascript"></script>
      <script src="../js/libs/box2d_v2.3.1.min.js" type="text/javascript"></script>
      <style type="text/css">
        body { background-color: #ccc; }
      </style>

      <script type="text/javascript">

      function massName(wid, mID, worldID)
      {
        return "b,m,w-" + wid + "," + mID + "," + worldID;
      }

      function connectionName(wid, cID, worldID)
      {
         return "b,c,w-" + wid + "," + cID + "," + worldID;
      }
      // function reverseConnectionName(connName)
      // {
      //   var split = connName.split('-');


      //   return {} 
      // }

      function createIESoRMass(jsonData, world, options)
      {
          var bd = new Box2D.b2BodyDef();
          bd.set_type(Box2D.b2_dynamicBody);
          var body = world.CreateBody(bd);
          body.CreateFixture(options.shape, options.density);
          body.SetTransform(new Box2D.b2Vec2(options.bodyPositionScale*parseFloat(jsonData.x), options.bodyPositionScale*parseFloat(jsonData.y)), 0.0);
          body.SetLinearVelocity(new Box2D.b2Vec2(0.0, 0.0));
          body.type = "mass";
          return body;
      }
      function resetIESoRMassLocation(body, jsonMass, options)
      {
          body.SetTransform(new Box2D.b2Vec2(options.bodyPositionScale*parseFloat(jsonMass.x), options.bodyPositionScale*parseFloat(jsonMass.y)), 0.0);
          body.SetLinearVelocity(new Box2D.b2Vec2(0.0, 0.0));
          body.SetAwake(1);
          body.SetActive(1);
      }

      //options: shape, density, and bodyPositionScale
      function createIESoRBody(wid, jsonBody, bodies, world, options)
      {
        //we need to label everything with the wid
        var masses = jsonBody.hl;
        var connections = jsonBody.c;

        var objectCount = 0;

        //now we need to add the body
        for(var m=0; m < masses.length; m++)
        {
          var jMass = masses[m];
          var boxMass = createIESoRMass(jMass, world, options);
          var massID = massName(wid, objectCount++, world.id);
          //we often do resets -- this would work well for that purpose
          bodies.masses[massID] = {box2d: boxMass, original: jMass};
        }

        //then we handle the connections
        for(var c=0; c < connections.length; c++)
        {
          //create a connection between two masses -- plz

        }
      }

      function resetIESoRConnection(bodies, jsonConn, options)
      {
      }

     

      function createIESoRConnection(jsonData, world, bodies)
      {
          
      }

      function resetIESoRBody(bodies, options)
      {
          //loop through and set the original location
        for(var massID in bodies.masses)
         {
            resetIESoRMassLocation(bodies.masses[massID].box2d, bodies.masses[massID].original, options);
         }

        for(var connID in bodies.connections)
         {
            resetIESoRConnection(bodies.connections[connID].box2d, bodies.connections[connID].original, options);
         }
      }


        var startUp, restart;
        window.onload = function(){
          var s = window.location.search.substr(1);
          var NUM = 0;//s.length > 1 ? +s : 500;
          var NUMRANGE = [];
          // while (NUMRANGE.length < NUM) NUMRANGE.push(NUMRANGE.length+1);
          
          var canvas = document.getElementById("canvas");
          canvas.width = screen.width*0.70;
          canvas.height = screen.height*0.55;

          var cw2 =canvas.width/2;
          var ch2 = canvas.height/2;

          var bodies = [null]; // Indexes start from 1
          // Box2D-interfacing code
          var gravity = new Box2D.b2Vec2(0.0, -10.0);
          var world = new Box2D.b2World(gravity);
          var bd_ground = new Box2D.b2BodyDef();
          var ground = world.CreateBody(bd_ground);
          var shape0 = new Box2D.b2EdgeShape();
          shape0.Set(new Box2D.b2Vec2(-40.0, -6.0), new Box2D.b2Vec2(40.0, -6.0));
          ground.CreateFixture(shape0, 0.0);
          var size = 1.0;
          var shape = new Box2D.b2PolygonShape();
          shape.SetAsBox(size, size);
          var ZERO = new Box2D.b2Vec2(0.0, 0.0);
          var temp = new Box2D.b2Vec2(0.0, 0.0);
          var dense = 5.0;
          var bodyPositionScale = 5.0;

          d3.json("../data/mData.json", function(iesorBodies)
          {
              // console.log(iesorBodies);
              var singleBody;
              for(var wid in iesorBodies)
              {
                //grab our body
                singleBody = iesorBodies[wid];
                console.log('Chosen body', singleBody);
                break;
              }

              bodies = {masses: {}, connections: {}};
              //start with zero-body -- wid = 0 for now
              var wid = 0;
              world.id = "0";
              var options = {shape: shape, density: dense, bodyPositionScale: bodyPositionScale};
              
              createIESoRBody(wid, singleBody, bodies, world, options);


               function resetPositions() {
                resetIESoRBody(bodies, options);
                //  NUMRANGE.forEach(function(i) {
                //   var body = bodies[i];
                //   temp.Set(25*(Math.random()-0.5), 2.0 + 1.5*i);
                //   body.SetTransform(temp, 0.0);
                //   body.SetLinearVelocity(ZERO);
                //   body.SetAwake(1);
                //   body.SetActive(1);
                // });
              }

              function readMass(massID, bodies, data)
              {
                var body = bodies.masses[massID].box2d;
                var bpos = body.GetPosition();
                data.x = bpos.get_x();
                data.y = bpos.get_y();
                data.angle = body.GetAngle();
              }

              var lastInactivity = Date.now();
              function someInactive() {
                var asleep = 0;
                for(var key in bodies.masses)
                {
                  if (!bodies.masses[key].box2d.IsAwake()) {
                    asleep++;
                    if (asleep == 3) return true;
                  }
                }
                return false;
              }
              // Main demo code
              var totalTime = 0;
              var boxes = [];
              var position = [0,0,0];
              function simulate(dt) {
                world.Step(dt, 2, 2);
                var data = { x: 0, y: 0, angle: 0 };
                // Read box2d data into JS objects
                for (var massID in bodies.masses) {
                  readMass(massID, bodies, data);
                  var renderObject = boxes[massID];
                  renderObject.left = cw2 + data.x;
                  renderObject.top = ch2 - data.y;
                  // renderObject.position[0] = data.x;
                  // renderObject.position[1] = data.y;
                  // renderObject.position[2] = 0;
                  renderObject.rotation = data.angle*180/Math.PI;//[0, 0, data.angle*180/Math.PI];
                }
                totalTime += dt;
                if (someInactive() || totalTime >= 30) restart();
              }
              var fpsInfo = {
                dts: 0,
                num: 0,
                lastHUD: Date.now(),
                allNum: 0,
                all: 0,
              };
              var outElement = null;
              function showFPS(dt) {
                if (!outElement) outElement = document.getElementById('out');
                var now = Date.now();
                fpsInfo.dts += dt;
                fpsInfo.num++;
                if (now - fpsInfo.lastHUD > 500) {
                  var curr = 1/(fpsInfo.dts/fpsInfo.num);
                  fpsInfo.allNum++;
                  var alpha = Math.min(1, 2/fpsInfo.allNum);
                  fpsInfo.all = alpha*curr + (1-alpha)*fpsInfo.all;
                  outElement.value = Math.round(curr) + ' / ' + Math.round(fpsInfo.all);
                  fpsInfo.lastHUD = now;
                  fpsInfo.dts = 0;
                  fpsInfo.num = 0;
                }
              }
              restart = function() {
                totalTime = 0;
                resetPositions();
              }
              var FLOOR_SIZE = 100;
              var FLOOR_HEIGHT = -56
              // CubicVR code
              startUp = function() {
                document.getElementById('info').innerHTML = '<b>Boxes: ' + NUM + '</b>';

                // create a wrapper around native canvas element (with id="c")
                var canvas = new fabric.Canvas('canvas');
                // create a rectangle object

                for (var massID in bodies.masses) {
                  var rect = new fabric.Rect({
                    left: 100,
                    top: 100,
                    fill: 'red',
                    width: 1,
                    height: 1
                  });

                  //add plz
                  canvas.add(rect);

                  //save the rect -- add to canvas
                  boxes[massID] = rect;
                }

                var start = null;
                function step(timestamp) {
                  if(!start) start= timestamp;

                  var dt = (timestamp - start)/1000.0;
                  
                  start = timestamp;

                  if(dt > 0){
                    //run the simulation plz
                    simulate(dt);
                    showFPS(dt);                  
                    canvas.renderAll();
                  }
                  window.requestAnimationFrame(step);
                }

                window.requestAnimationFrame(step);
              }
              startUp();

          });



         
        
        }
      </script>
    </head>
    <body>
      <center>
        <h2>box2d.js WebGL Demo</h2>
        <form>
          Boxes :
          <select name="boxes">
            <option value="500" selected>(pick)</option>
            <option value="10">10</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="300">300</option>
            <option value="500">500</option>
            <option value="750">750</option>
            <option value="1000">1000</option>
          </select>
          <input type="button" value="go!" onclick="window.location = window.location.toString().split('?')[0] + '?' + boxes.value;">
        </form>
        <canvas id="canvas" width="600" height="500"></canvas>
        <br><br>
        <div>FPS (current / stable): <input type="text" id="out" readonly="1" size="7"></div>
        <div id="info"></div>
        <p>
        This is <b><a href="https://github.com/kripken/box2d.js">box2d.js</a></b>, a port of
        the <b><a href="http://box2d.org/">Box2D physics engine</a></b> from C++ to JavaScript
        using <b><a href="http://emscripten.org">Emscripten</a></b>. WebGL rendering in this demo is done using
        <b><a href="https://github.com/cjcliffe/CubicVR.js/">CubicVR.js</a></b>.
        </p>
        <input type="button" onclick="restart()" value="restart">
      </center>
    </body>
</html>
